{
    "componentChunkName": "component---src-templates-wp-post-tsx",
    "path": "/crypter-cle-usb-linux",
    "result": {"pageContext":{"id":"99445427-b91f-563e-bbf0-8632b4c9655b","fileAbsolutePath":"/Users/behrouze/Sources/gatsby-blog/obsidian/Blog/crypter-cle-usb-linux.md","frontmatter":{"categories":["securite"],"date":"2020-03-01","lastUpdate":null,"tags":["bash","linux","securite","cryptage","usb"],"title":"Cryptsetup pour crypter une clé USB sous Linux"},"html":"<blockquote>\n<p><strong>Cryptsetup</strong> fournit une <em>interface</em> pour configurer le <em>chiffrement sur des périphériques de bloc</em> (comme des partitions /home ou d’espace d’échange (swap)) en utilisant <em>dm-crypt</em>, un <em>sous-système</em> transparent de chiffrement de disques dans le noyau Linux.<br>\nIl permet une prise en charge de <strong>LUKS</strong> (« Linux Unified Key Setup »), le <em>standard</em> associé au noyau Linux pour le chiffrement de disque.</p>\n<p>packages.debian.org</p>\n</blockquote>\n<h2>Identifier le device de sa clé USB</h2>\n<p>Il faut tout d’abord <em>identifier</em> la clé USB qui nous intéresse, avant d’éventuellement la <em>partitionner</em> pour enfin l’<em>encrypter</em> et la <em>formater</em>.<br>\nVoici plusieurs 3 méthodes :</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">lsblk -fs                           <span class=\"token comment\"># list block devices chercher /dev/sd? pour les clé USB</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">cat</span> /var/log/messages <span class=\"token operator\">|</span> <span class=\"token function\">tail</span>   <span class=\"token comment\"># fonctionne immédiatement après insertion de la clé USB</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">fdisk</span> /dev/sda1                <span class=\"token comment\"># puis tapper p (infos de partitions) puis partitionner la clé</span></code></pre></div>\n<h2>Crypter la clé USB</h2>\n<p>On va utiliser pour le cryptage/décryptage, un outil dénommé <code class=\"language-text\">cryptsetup</code> avec LUKS (Linux Unified Key Setup).</p>\n<h3>Pré-requis</h3>\n<p>Il faut tout d’abord disposer des modules noyaux suivants <code class=\"language-text\">dm-crypt</code> <code class=\"language-text\">sha256</code> <code class=\"language-text\">aes</code></p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> modprobe dm-crypt sha256 aes         <span class=\"token comment\"># chargement des modules nécessaires</span>\n<span class=\"token function\">sudo</span> lsmod                                <span class=\"token comment\"># vérifier qu'ils sont bien chargés</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> cryptsetup</code></pre></div>\n<h3>Crypter le device</h3>\n<p>En considérant ci-dessous la clé USB est identifiée en tant que <em>/dev/sda1</em> nous allons encrypter la partition avec la commande <code class=\"language-text\">cryptsetup luksFormat</code>.<br>\n<em>Attention bien identifier votre device au risque de perdre le contenu de cette partition</em></p>\n<p>Cet opération va nous demander une passphrase (ou mot de passe) qu’il ne faudra pas perdre ! et il est possible de</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> cryptsetup -y luksFormat /dev/sdaXX -c aes -s <span class=\"token number\">256</span> -h sha256 <span class=\"token comment\"># va nous demander 2 fois une passphrase secrète qui nous servira de clé privée</span></code></pre></div>\n<h3>Monter/démonter la partition cryptée</h3>\n<p>Le montage et démontage de la partition cryptée s’effectue au moyen des commandes <code class=\"language-text\">cryptsetup luksOpen</code> et <code class=\"language-text\">cryptsetup luksClose</code>. Une fois décryptée la partition devra être montée classiquement via un mount, il faut donc garder à l’esprit qu’il faut <strong>effectuer 2 sortes de montages/démontages</strong>.</p>\n<h4>Formatage et 1er montage</h4>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> cryptsetup luksOpen /dev/sda1 secure <span class=\"token comment\"># va créer /dev/mapper/secure</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">mkfs</span> -t ext4 -m <span class=\"token number\">1</span> /dev/mapper/secure <span class=\"token comment\"># formattage en ext4</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">mkdir</span> /media/macleusb\n<span class=\"token function\">sudo</span> <span class=\"token function\">mount</span> /dev/mapper/secure /media/macleusb\n<span class=\"token function\">sudo</span> <span class=\"token function\">chown</span> xxx:xxx /media/macleusb        <span class=\"token comment\"># si la clé reste connectée</span></code></pre></div>\n<p>à partir de là nous avons la clé cryptée montée.</p>\n<h4>Montage suivants</h4>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> cryptsetup luksOpen /dev/sda1 secure\n<span class=\"token function\">sudo</span> <span class=\"token function\">mount</span> /dev/mapper/secure /media/macleusb</code></pre></div>\n<h4>Démontage</h4>\n<p>avant de retirer la clé USB ne pas oublier de:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> <span class=\"token function\">umount</span> /media/macleusb           <span class=\"token comment\"># démontage du volume déchiffré</span>\n<span class=\"token function\">sudo</span> cryptsetup luksClose secure <span class=\"token comment\"># fermeture du volume chiffré</span>\n\n<span class=\"token function\">lsof</span> /media/xxx                  <span class=\"token comment\"># si le umount échoue, pour plus d'infos</span></code></pre></div>\n<h2>Liens</h2>\n<ul>\n<li>doc <a href=\"https://gitlab.com/cryptsetup/cryptsetup/-/wikis/FrequentlyAskedQuestions\">cryptsetup FAQ</a></li>\n</ul>"}},
    "staticQueryHashes": ["1026020893","1333896537","28434099"]}