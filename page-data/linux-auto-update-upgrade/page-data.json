{
    "componentChunkName": "component---src-templates-wp-post-tsx",
    "path": "/linux-auto-update-upgrade",
    "result": {"pageContext":{"id":"3f6c3af1-0461-51c2-bbab-0d9472d9779e","fileAbsolutePath":"/home/behrouze/Sources/gatsby-blog/obsidian/Blog/linux-auto-update-upgrade.md","frontmatter":{"categories":["devops"],"date":"2019-08-16","lastUpdate":null,"tags":["debian","devops","linux","raspberry-pi","securite","ubuntu","shell"],"title":"Linux auto update/upgrade"},"html":"<p><strong>unattended-upgrades</strong> (<a href=\"https://packages.debian.org/apt-listchanges\">apt-listchanges</a> (sur Ubuntu par ex) qui permet de nous transmettre un mail lors de chaque MAJ de nos systèmes.</p>\n<h2>Installation et configuration</h2>\n<h3>Installation</h3>\n<p><strong>unattended-upgrades</strong> est installé par défaut dans les distrib Ubuntu mais pas dans les Raspbian:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> unattended-upgrades</code></pre></div>\n<h3>Configuration</h3>\n<p><strong>unattended-upgrades</strong> dispose de 2 fichiers de configuration sont:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> <span class=\"token function\">vi</span> /etc/apt/apt.conf.d/50unattended-upgrades <span class=\"token comment\"># configuration APT</span>\n<span class=\"token function\">sudo</span> <span class=\"token function\">vi</span> /etc/apt/apt.conf.d/20auto-upgrades <span class=\"token comment\"># paramétrage de unattended-upgrades</span>\n<span class=\"token comment\"># Ajouter APT::Periodic::RandomSleep \"600\"</span></code></pre></div>\n<p>Il est possible de générer le fichier <code class=\"language-text\">_20auto-upgrades_</code> en utilisant la commande suivante :</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> dpkg-reconfigure --priority<span class=\"token operator\">=</span>low unattended-upgrades</code></pre></div>\n<h2>Run</h2>\n<p><strong>Vérifier</strong> ce qui sera installé avec cette configuration avec (-d –dry-run) puis sans ces arguments si tout est OK:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> unattended-upgrade -v -d --dry-run</code></pre></div>\n<p>Les <strong>logs</strong> d’exécutions se trouvent dans:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">/var/log/unattended-upgrades/unattended-upgrades-dpkg.log\n/var/log/unattended-upgrades/unattended-upgrades.log <span class=\"token comment\"># si lancé en mode Debug avec -d</span>\n/var/log/dpkg.log <span class=\"token comment\"># log par défaut d'APT</span></code></pre></div>\n<h2>Exemples de configuration</h2>\n<h3>lister sa configuration</h3>\n<p>Il faut utiliser la commande <code class=\"language-text\">apt-config</code> pour être sure de lister la <em>config effective</em>:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> apt-config dump<span class=\"token operator\">|</span><span class=\"token function\">grep</span> Periodic</code></pre></div>\n<h3>fichier 50unattended-upgrades</h3>\n<p>voici un exemple de fichier <code class=\"language-text\">/etc/apt/apt.conf.d/50unattended-upgrades</code> pour un <strong>Raspberry Pi</strong> (noter l’option <code class=\"language-text\">o=Raspbian</code>) et pour lequel on souhaite éviter les mises à jour automatiques de Nginx (<code class=\"language-text\">Package-Blacklist</code>):</p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\">Unattended-Upgrade::Origins-Pattern {\n      <span class=\"token key attr-name\">\"o</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">Raspbian,a=stable\";</span>\n      <span class=\"token key attr-name\">\"o</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">Raspbian,a=stable-updates\";</span>\n      <span class=\"token key attr-name\">\"o</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">Raspbian,a=proposed-updates\";</span>\n      <span class=\"token key attr-name\">\"o</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">Raspbian,n=${distro_codename}\";</span>\n      <span class=\"token key attr-name\">\"o</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">Raspbian,n=${distro_codename}-updates\";</span>\n      <span class=\"token key attr-name\">\"o</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">Raspbian,n=${distro_codename}-proposed-updates\";</span>\n      <span class=\"token key attr-name\">\"o</span><span class=\"token punctuation\">=</span><span class=\"token value attr-value\">Raspbian,n=${distro_codename},l=Debian-Security\";</span>\n};\n\nUnattended-Upgrade::Package-Blacklist {\n\t\"nginx\";\n};\n\nUnattended-Upgrade::Automatic-Reboot \"true\"</code></pre></div>\n<h3>fichier 20auto-upgrades</h3>\n<p>voici un exemple de configuration d’<strong>unattended-upgrades</strong> fichier <code class=\"language-text\">/etc/apt/apt.conf.d/20auto-upgrades</code></p>\n<div class=\"gatsby-highlight\" data-language=\"ini\"><pre class=\"language-ini\"><code class=\"language-ini\">APT::Periodic::AutocleanInterval \"7\";\nAPT::Periodic::Download-Upgradeable-Packages \"1\";\nAPT::Periodic::RandomSleep \"600\";\nAPT::Periodic::Unattended-Upgrade \"1\";\nAPT::Periodic::Update-Package-Lists \"1\";</code></pre></div>"}},
    "staticQueryHashes": ["1026020893","1333896537","28434099"]}