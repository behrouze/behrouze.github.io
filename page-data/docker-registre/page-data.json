{"componentChunkName":"component---src-templates-wp-post-tsx","path":"/docker-registre","result":{"pageContext":{"id":"07b84794-4cfa-527f-afb3-ce168dc762c5","fileAbsolutePath":"/home/behrouze/Sources/blog/obsidian/Blog/docker-registre.md","frontmatter":{"categories":["devops"],"date":"2019-12-13","lastUpdate":null,"tags":["docker","linux","raspberry-pi"],"title":"Registre Docker privé"},"html":"<p>Docker permet d’utiliser <a href=\"https://docs.docker.com/registry/deploying/#run-a-local-registry\">auto-héberger des registres Docker</a> sur notre propre infrastructure.</p>\n<p>On peut vouloir héberger un registre Docker sur ses serveurs pour divers raisons comme pour par exemple <em>« maîtriser » l’accès à ses images docker</em>, les <em>rendre disponible sur le réseau local</em> (qui peut être isolé d’internet), pour des raisons de <em>performances</em> (notamment avec une CI locale) ou juste pour <em>comprendre</em> ? comment fonctionne l’écosystème Docker.</p>\n<p>Ce poste est basé de la <a href=\"https://docs.docker.com/registry/insecure/#use-self-signed-certificates\">certificats auto-générés/signés</a>.</p>\n<h1>Vue d’ensemble</h1>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 781px; box-shadow: 3px 5px 4px rgba(0,0,0,.1);margin:1rem;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a03071a16c0af5a951e9ddffb7349522/7fee5/Docker-Registry-1.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 47.41784037558685%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAYAAAAywQxIAAAACXBIWXMAAAsTAAALEwEAmpwYAAACs0lEQVQozyVSe0iTcRQ936dl6Jz5hBqhJgmlvcTCwgjtof1jIqt8QYUOC1Fyywdo+EAXmESZpE6dha80yeeY6bS5uan7Nt20udyWipjPjJAsSuIXywsXzvnjHjjnXCC5hrpR1kYzOubI0gYJUOiWQnoG1d7EakRk2Ttqv0BMufDrsLtiJFYyAJuDu1WT4IkMyGuah23YfDGc+WIACSVUc/1zyjRjCRaKsiteNAqzfizvcAgheLO4Al5ELG3x86DnfVxpAuAOISAbBIJXs07ZDVZWW+8mKjq/gc2vB3hFgH9sNkX6VbQq/wmS3Xz1SSxOTum1GJRERNt3ALCJmAFY9u7iclGzfXWfgq7rVtOnhHIaUcVwzmyjXTKqcZyXCBzKqKE00wYYJXLEA8fi4Obdca/wvw0ZDZjd7U6YgXSLA9KsgItJXIXhjzNQKJSgctUAqxZI7QPS2ynPh9UALqdTBt1EkEY9FjG9vHB10mS8pdPqkrSDssPkSjAMQMJmcd7f1dvchcXHBYJPyystBr1Bsr2+lOyUMxB5oEjZCcFAEARyOGT10rgQcJ+aWlsI1JimLhkn9OfUCuVBWb+EU8lPcyYsYAqIWn+Qol+Oi5KPh54OZba2Tw4PfQglpiGvkGfq6LDyEUl8rcqXK1Ih6HEPjeQzPvAHzjsCRytK8kHIT4RdT+VdjIz1SOEmYiz0rOMY4M4AHiAE1lElRjUaTIyNgPyZdCbfLSFk3epFyG9kNUkp3ATQkiPMbX1UyhOwAvF1xrKv5W1XlvS9LLy6tQs2ET0AnS1UQtDQLrETtg/YFTZ204TMgZDPIGQN3JcdsH0G0jKf7vlCdvzmfm15226kao3Dxsaqv9Fk4th4TEoBPe8KataVpmwtwzMc3SoGr6XDtHJ0nK0a17C1Wq3junmKYhgG/wBuOjy482Ye6wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/a03071a16c0af5a951e9ddffb7349522/bc663/Docker-Registry-1.webp 213w,\n/static/a03071a16c0af5a951e9ddffb7349522/8dc4f/Docker-Registry-1.webp 425w,\n/static/a03071a16c0af5a951e9ddffb7349522/42cfc/Docker-Registry-1.webp 781w\"\n              sizes=\"(max-width: 781px) 100vw, 781px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/a03071a16c0af5a951e9ddffb7349522/3cb16/Docker-Registry-1.png 213w,\n/static/a03071a16c0af5a951e9ddffb7349522/2fbbf/Docker-Registry-1.png 425w,\n/static/a03071a16c0af5a951e9ddffb7349522/7fee5/Docker-Registry-1.png 781w\"\n            sizes=\"(max-width: 781px) 100vw, 781px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/a03071a16c0af5a951e9ddffb7349522/7fee5/Docker-Registry-1.png\"\n            alt=\"registre docker local\"\n            title=\"registre docker local\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h1>Installation</h1>\n<h2>Coté serveur</h2>\n<p>Le registre docker que nous allons utiliser est simplement une instance d’une image officielle <code class=\"language-text\">registry:2</code>, il va donc falloir avoir un environnement docker fonctionnel installé sur le serveur et une pair <a href=\"https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs\">clé SSL/certificat</a> car la connexion au registre docker doit être sécurisée (requis par défaut).</p>\n<h3>Génération de la clé et certificat par OpenSsl</h3>\n<p>D’abord se placer dans le dossier dans lequel nous allons stocker la clé privée et le certificat signé (dossier <code class=\"language-text\">certs</code>), puis les générer:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">openssl req <span class=\"token parameter variable\">-newkey</span> rsa:4096 <span class=\"token parameter variable\">-nodes</span> <span class=\"token parameter variable\">-sha256</span>      <span class=\"token punctuation\">\\</span>\n     <span class=\"token parameter variable\">-keyout</span> docker-registry.key <span class=\"token parameter variable\">-x509</span> <span class=\"token parameter variable\">-days</span> <span class=\"token number\">365</span> <span class=\"token punctuation\">\\</span>\n     <span class=\"token parameter variable\">-out</span> docker-registry.crt</code></pre></div>\n<h3>Configuration [optionnel]</h3>\n<p>Il est possible de configurer finement le Registre via un fichier <a href=\"https://docs.docker.com/registry/configuration/#list-of-configuration-options\">config.yml</a> monté dans un volume, mais c’est <em>optionnel</em> (sauf si vous visez une configuration de production):</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">-p</span> <span class=\"token number\">443</span>:443 <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>always <span class=\"token parameter variable\">--name</span> registry   <span class=\"token punctuation\">\\</span>\n      <span class=\"token parameter variable\">-v</span> <span class=\"token variable\"><span class=\"token variable\">`</span><span class=\"token builtin class-name\">pwd</span><span class=\"token variable\">`</span></span>/config.yml:/etc/docker/registry/config.yml <span class=\"token punctuation\">\\</span>\n      registry:2</code></pre></div>\n<h3>Démarrer le registre local</h3>\n<p>Démarrer le conteneur docker basé sur l’image officielle <code class=\"language-text\">registry:2</code> :</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">docker</span> run <span class=\"token parameter variable\">-d</span> <span class=\"token parameter variable\">--restart</span><span class=\"token operator\">=</span>always <span class=\"token parameter variable\">--name</span> mon-registre <span class=\"token parameter variable\">-v</span> <span class=\"token string\">\"<span class=\"token variable\"><span class=\"token variable\">$(</span><span class=\"token builtin class-name\">pwd</span><span class=\"token variable\">)</span></span>\"</span>/certs:/certs <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">REGISTRY_HTTP_ADDR</span><span class=\"token operator\">=</span><span class=\"token number\">0.0</span>.0.0:443 <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">REGISTRY_HTTP_TLS_CERTIFICATE</span><span class=\"token operator\">=</span>/certs/docker-registry.crt <span class=\"token parameter variable\">-e</span> <span class=\"token assign-left variable\">REGISTRY_HTTP_TLS_KEY</span><span class=\"token operator\">=</span>/certs/docker-registry.key <span class=\"token parameter variable\">-p</span> <span class=\"token number\">443</span>:443 registry:2\n<span class=\"token comment\"># se placer dans le dossier contenant le dossier certs</span></code></pre></div>\n<h2>Coté client</h2>\n<h3>Copie du certificat serveur sur les clients Docker</h3>\n<p>Il faut uniquement installer le certificat (fichier <code class=\"language-text\">docker-registry.crt</code>) que nous avons précédemment généré coté serveur dans un dossier spécifique <code class=\"language-text\">/etc/docker/certs.d/mon-serveur:443/docker-registry.crt</code> de chaque client docker qui souhaite communiquer avec.</p>\n<h3>Envoi réception des images</h3>\n<p>Utiliser les commandes docker push/pull avec la <a href=\"https://docs.docker.com/engine/security/trust/content_trust/\">syntaxe suivante</a> <code class=\"language-text\">[REGISTRY_HOST[:REGISTRY_PORT]/]REPOSITORY[:TAG]</code> pour envoyer/recevoir vers son registre privé exemple :</p>\n<p>docker pull mon-serveur:443/mon-image</p>\n<h1>Troubleshooting des erreurs docker</h1>\n<p>Si vous tentez de récupérer une image sur votre Registre Docker fraichement installé, vous risquez de rencontrer quelques erreurs dont certains liés aux certificats.</p>\n<h2>Vérifier la liaison réseau</h2>\n<p>Il peut être utile de vérifier depuis le client que le conteneur docker est bien lancé coté serveur et qu’il écoute bien sur le port spécifié (443 dans notre exemple):</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">nc</span> <span class=\"token parameter variable\">-vz</span>  mon-serveur <span class=\"token number\">443</span>\n\n<span class=\"token comment\"># le résultat devrait ressembler à cela:</span>\n<span class=\"token comment\"># Connection to mon-serveur 443 port [tcp/https] succeeded!</span></code></pre></div>\n<h2>Server gave HTTP response to HTTPS client</h2>\n<p>Error response from daemon: Get <a href=\"https://mon-serveur:443/v2/\">https://mon-serveur:443/v2/</a>: http: server gave HTTP response to HTTPS client</p>\n<h3>Explication</h3>\n<p>Le serveur (le registre docker) a été lancé sans certificat spécifiés par les variables d’environnements <code class=\"language-text\">REGISTRY_HTTP_TLS_CERTIFICATE</code> et/ou <code class=\"language-text\">REGISTRY_HTTP_TLS_KEY</code></p>\n<h3>Solution</h3>\n<p>Vérifier que vous avez bien les fichiers <code class=\"language-text\">.cert</code> et <code class=\"language-text\">.key</code> (avec le bon chemin lors du lancement de la commande docker run) et que vous avez bien renseigné les options <code class=\"language-text\">-e</code> comme spécifié ci-dessus (installation coté serveur).</p>\n<h2>Unknown authority: certificat manquant coté client</h2>\n<p>Error response from daemon: Get <a href=\"https://mon-serveur:443/v2/\">https://mon-serveur:443/v2/</a>: x509: certificate signed by unknown authority</p>\n<h3>Explication</h3>\n<p>Ce message indique <em>certificate signed by unknown authority</em>, c’est à dire que votre client ne reconnait pas l’autorité qui a signé le certificat SSL recu de votre serveur.</p>\n<h3>Solution</h3>\n<p>copier votre certificat <code class=\"language-text\">docker-registry.crt</code> sur votre client dans le dossier <code class=\"language-text\">/etc/docker/certs.d/mon-serveur:443/docker-registry.crt</code></p>\n<h2>x509: certificate is not valid</h2>\n<p>Error response from daemon: Get <a href=\"https://mon-serveur:443/v2/\">https://mon-serveur:443/v2/</a>: x509: certificate is not valid for any names, but wanted to match mon-serveur</p>\n<h3>Explication</h3>\n<p>Ce message indique <em>certificate is not valid … but wanted to match mon-serveur</em>, c’est à dire que la <strong>connexion a bien été établie</strong> avec le registre docker privé, mais que le <strong>certificat renvoyé ne correspond pas nom de domaine</strong> (ici mon-serveur).</p>\n<h3>Solution</h3>\n<p>Régénérer le certificat et la clé coté serveur en renseignant correctement la question :</p>\n<p>Common Name (e.g. server FQDN or YOUR name) []:mon-serveur</p>"}},"staticQueryHashes":["1026020893","28434099","3153813225"]}