{
    "componentChunkName": "component---src-templates-wp-post-tsx",
    "path": "/mariadb-mysql",
    "result": {"pageContext":{"id":"4dd64e67-f5c1-5375-88b5-56b74bb8bc7e","fileAbsolutePath":"/home/behrouze/Sources/gatsby-blog/obsidian/Blog/mariadb-mysql.md","frontmatter":{"categories":[""],"date":"2022-02-16","lastUpdate":"2022-02-16","tags":["sql","mariadb","mysql","tips","cheatsheet"],"title":"MariaDB MySQL"},"html":"<h1>Use DB ou prefixe</h1>\n<h2>Use</h2>\n<p>Pour utiliser une table il est possible de se placer sur la DB souhaitée avec <code class=\"language-text\">USE xxx;</code> puis executer les commandes dessus :</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">USE</span> mysql<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">FROM</span> <span class=\"token keyword\">user</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>L'interet de cette syntaxe, est qu'en mode interactif, cela nous évite de tapper le préfixe à chaque commande pour une succession de commandes concernant la meme table.</p>\n<h2>Prefixe</h2>\n<p>il est possible de prefixer le nom des tables par le nom de la base :</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">user</span> <span class=\"token keyword\">FROM</span> mysql<span class=\"token punctuation\">.</span><span class=\"token keyword\">user</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>L'interet de cette seconde syntaxe est qu'elle est plus rapide pour exécuter 1 seule commtande sur une autre table comme ci-dessus sur une table système.</p>\n<h1>Infos</h1>\n<h2>Schéma BDD</h2>\n<p>Les 3 commandes suivantes sont équivalente pour obtenir les schéma de la BDD courante:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SHOW</span> <span class=\"token keyword\">DATABASES</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SHOW</span> SCHEMAS<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> schema_name <span class=\"token keyword\">FROM</span> information_schema<span class=\"token punctuation\">.</span>schemata<span class=\"token punctuation\">;</span></code></pre></div>\n<p>attention si l'option <code class=\"language-text\">--skip-show-database</code> a été utilisé pour lancer le serveur, aucune info ne sera retournée à moins d'avoir le privilege <code class=\"language-text\">SHOW DATABASES</code>.</p>\n<h3>Filtrer</h3>\n<p>Pour affiner les recherches utliser l'opérateur <code class=\"language-text\">LIKE</code> :</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SHOW</span> <span class=\"token keyword\">DATABASES</span> <span class=\"token operator\">LIKE</span> <span class=\"token string\">\"wp%\"</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Tables</h2>\n<p>Pour lister les tables</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SHOW</span> <span class=\"token keyword\">TABLES</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SHOW</span> <span class=\"token keyword\">FULL</span> <span class=\"token keyword\">TABLES</span><span class=\"token punctuation\">;</span>  <span class=\"token comment\">--montre le table_type \"BASE TABLE\" ou \"VIEW\"</span></code></pre></div>\n<p>Filtrer avec <code class=\"language-text\">LIKE</code> ou <code class=\"language-text\">WHERE</code> :</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SHOW</span> <span class=\"token keyword\">FULL</span> <span class=\"token keyword\">TABLES</span> <span class=\"token keyword\">WHERE</span> table_type <span class=\"token operator\">=</span> <span class=\"token string\">'VIEW'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SHOW</span> <span class=\"token keyword\">FULL</span> <span class=\"token keyword\">TABLES</span> <span class=\"token operator\">LIKE</span> <span class=\"token string\">\"%post%\"</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Pour avoir des infos sur la structure d'une table</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">DESC</span> mysql<span class=\"token punctuation\">.</span><span class=\"token keyword\">user</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">DESCRIBE</span> mysql<span class=\"token punctuation\">.</span><span class=\"token keyword\">user</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SHOW</span> <span class=\"token keyword\">COLUMNS</span> <span class=\"token keyword\">FROM</span> mysql<span class=\"token punctuation\">.</span><span class=\"token keyword\">user</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SHOW</span> <span class=\"token keyword\">FULL</span> <span class=\"token keyword\">COLUMNS</span> <span class=\"token keyword\">FROM</span> mysql<span class=\"token punctuation\">.</span><span class=\"token keyword\">user</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>Le mot clé FULL ajoute les champs <code class=\"language-text\">collation</code>, <code class=\"language-text\">privileges</code> et <code class=\"language-text\">comment</code></p>\n<h3>Filtrer</h3>\n<p>Filtrer <code class=\"language-text\">SHOW [FULL] COLUMNS</code> avec <code class=\"language-text\">LIKE</code> ou <code class=\"language-text\">WHERE</code> :</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SHOW</span> <span class=\"token keyword\">COLUMNS</span> <span class=\"token keyword\">FROM</span> wp_blog_behrouze<span class=\"token punctuation\">.</span>wp_posts <span class=\"token operator\">LIKE</span> <span class=\"token string\">\"post%\"</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SHOW</span> <span class=\"token keyword\">COLUMNS</span> <span class=\"token keyword\">FROM</span> wp_blog_behrouze<span class=\"token punctuation\">.</span>wp_posts <span class=\"token keyword\">WHERE</span> <span class=\"token keyword\">Type</span> <span class=\"token operator\">LIKE</span> <span class=\"token string\">\"text\"</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Users</h2>\n<h3>Utilisateur courant</h3>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">select</span> <span class=\"token keyword\">user</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">select</span> <span class=\"token keyword\">current_user</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token operator\">+</span><span class=\"token comment\">----------------+</span>\n<span class=\"token operator\">|</span> <span class=\"token keyword\">user</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>         <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----------------+</span>\n<span class=\"token operator\">|</span> root<span class=\"token variable\">@localhost</span> <span class=\"token operator\">|</span>\n<span class=\"token operator\">+</span><span class=\"token comment\">----------------+</span>\n<span class=\"token number\">1</span> <span class=\"token keyword\">row</span> <span class=\"token operator\">in</span> <span class=\"token keyword\">set</span> <span class=\"token punctuation\">(</span><span class=\"token number\">0.001</span> sec<span class=\"token punctuation\">)</span></code></pre></div>\n<h3>Liste des utilisateurs de la BDD</h3>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">user</span><span class=\"token punctuation\">,</span> host <span class=\"token keyword\">FROM</span> mysql<span class=\"token punctuation\">.</span><span class=\"token keyword\">user</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">SELECT</span> <span class=\"token keyword\">user</span><span class=\"token punctuation\">,</span>\n    host<span class=\"token punctuation\">,</span>\n    is_role<span class=\"token punctuation\">,</span>\n    password_expired<span class=\"token punctuation\">,</span>\n    Password\n<span class=\"token keyword\">FROM</span> mysql<span class=\"token punctuation\">.</span><span class=\"token keyword\">user</span><span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Permissions</h2>\n<p>Les Users sont créés de base sans aucun droits, c'est le <code class=\"language-text\">GRANT USAGE</code> , cela leurs permets uniquement de se logger.</p>\n<p>Pour checker les permissions du user avec lequel on s'est connecté:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SHOW</span> GRANTS<span class=\"token punctuation\">;</span>  <span class=\"token comment\">-- équivalent à SHOW GRANTS FOR CURRENT_USER; ou CURRENT_USER();</span></code></pre></div>\n<p>Pour lister les users de la BDD (et avoir la combinaison <code class=\"language-text\">user@host</code>) :</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SHOW</span> GRANTS <span class=\"token keyword\">FOR</span> le_user_a_checker<span class=\"token variable\">@le_host</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>A noter qu'il est possible d'écrire:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token string\">'username'</span><span class=\"token variable\">@'hostname'</span>\n<span class=\"token string\">\"username\"</span><span class=\"token variable\">@\"hostname\"</span>\n<span class=\"token identifier\"><span class=\"token punctuation\">`</span>username<span class=\"token punctuation\">`</span></span><span class=\"token variable\">@`hostname`</span></code></pre></div>\n<h2>Threads courants</h2>\n<p>Les 2 commandes suivantes sont équivalentes:</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SHOW</span> PROCESSLIST<span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">SELECT</span> id<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">user</span><span class=\"token punctuation\">,</span>\n    host<span class=\"token punctuation\">,</span>\n    db<span class=\"token punctuation\">,</span>\n    command<span class=\"token punctuation\">,</span>\n    <span class=\"token keyword\">time</span><span class=\"token punctuation\">,</span>\n    State<span class=\"token punctuation\">,</span>\n    Info<span class=\"token punctuation\">,</span>\n    Progress\n<span class=\"token keyword\">FROM</span> information_schema<span class=\"token punctuation\">.</span>processlist<span class=\"token punctuation\">;</span></code></pre></div>\n<h2>Astuces</h2>\n<h3>Affichage en colonne</h3>\n<p>Pour un affichage plus lisible, surtout lors d'un <code class=\"language-text\">select *</code> mysql nous offre la possibilité d'afficher en mode colonne en finalisant la commande par <code class=\"language-text\">\\G;</code> :</p>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">SELECT</span> <span class=\"token operator\">*</span> <span class=\"token keyword\">FROM</span> mysql<span class=\"token punctuation\">.</span><span class=\"token keyword\">user</span> <span class=\"token keyword\">WHERE</span> <span class=\"token keyword\">User</span> <span class=\"token operator\">LIKE</span> <span class=\"token string\">'usr_%'</span> \\G<span class=\"token punctuation\">;</span></code></pre></div>\n<h3>mode interactif</h3>\n<p><code class=\"language-text\">CTRL + U</code> supprime les caractères précédent le curseur, donc tout ce qui est a sa gauche\n<code class=\"language-text\">CTRL + K</code> idem pour les caratères à droite jusqu'à la fin de ligne\n<code class=\"language-text\">\\c + ENTER</code> permet de clear le buffer (indiqué dans le msg de login)</p>\n<h1>Créations</h1>\n<h2>User</h2>\n<div class=\"gatsby-highlight\" data-language=\"sql\"><pre class=\"language-sql\"><code class=\"language-sql\"><span class=\"token keyword\">CREATE</span> <span class=\"token keyword\">USER</span> <span class=\"token punctuation\">[</span><span class=\"token keyword\">IF</span> <span class=\"token operator\">NOT</span> <span class=\"token keyword\">EXISTS</span><span class=\"token punctuation\">]</span> account_name\nIDENTIFIED <span class=\"token keyword\">BY</span> <span class=\"token string\">'password'</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p><em>account_name</em> peut etre une combinaison <code class=\"language-text\">user_name@host</code> ou juste <code class=\"language-text\">user_name</code> auquel cas le host attribué est <code class=\"language-text\">%</code> automatiquement. La partie host designe la machine depuis laquel ce user pourra se connecter, et <code class=\"language-text\">%</code> signifie <em>depuis partout</em> (donc attention on permet les remote access) !</p>\n<h1>Connexion distant</h1>\n<p>Pour autoriser les connexion distantes il faut intervenir sur la configuration réseau du serveur, dans la config mariadb et dans le paramétrage de la base de données.</p>\n<h2>config Serveur</h2>\n<p>Coté serveur vérifier que le port mariadb/mysql <code class=\"language-text\">3306</code> (ou celui que vous aurez défini dans <code class=\"language-text\">/etc/mysql/mariadb.cnf</code>) est bien ouvert au niveau réseau :</p>\n<ul>\n<li>\nvérifier les config du firewall local <a href=\"/ufw\" title=\"ufw\">ufw</a> ou iptables -L\n</li>\n<li>vérifier que mysql écoute bien sur le port <code class=\"language-text\">3306</code> avec un <code class=\"language-text\">netstat -tupln</code></li>\n</ul>\n<h2>config mariadb</h2>\n<p>autoriser les connexions distantes au daemon <code class=\"language-text\">mariadbd</code> dans le fichier de config du serveur : <code class=\"language-text\">/etc/mysql/mariadb.conf.d/50-server.cnf</code></p>\n<div class=\"gatsby-highlight\" data-language=\"cnf\"><pre class=\"language-cnf\"><code class=\"language-cnf\">bind-address            = 127.0.0.1 # interdit les connexions distantes\nbind-address            = 0.0.0.0   # autorise les connexions distantes</code></pre></div>\n<p>redémarrer le service :</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> systemctl restart mariadb</code></pre></div>\n<h2>config en BDD</h2>\n<p>Attribuer les <a href=\"https://www.mysqltutorial.org/mysql-grant.aspx\">droits</a> (pas forcément <code class=\"language-text\">ALL</code>) au couple <code class=\"language-text\">username@host</code> à l'entité de BDD souhaitée:</p>\n<div class=\"gatsby-highlight\" data-language=\"text\"><pre class=\"language-text\"><code class=\"language-text\">GRANT ALL ON la_dbb.* to 'username'@'hostname' IDENTIFIED BY 'password'</code></pre></div>\n<p>Le <code class=\"language-text\">FLUSH PRIVILEGES</code> n'est pas nécessaire pour appliquer les modifs comme <a href=\"https://dev.mysql.com/doc/refman/8.0/en/privilege-changes.html\">indiqué dans la doc</a>.</p>"}},
    "staticQueryHashes": ["1026020893","1333896537","28434099"]}