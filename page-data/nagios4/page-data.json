{"componentChunkName":"component---src-templates-wp-post-tsx","path":"/nagios4","result":{"pageContext":{"id":"c64f4282-dcdb-5305-95b6-3ed0be276f4e","fileAbsolutePath":"/home/behrouze/Sources/blog/obsidian/Blog/nagios4.md","frontmatter":{"categories":["linux"],"date":"2018-08-31","lastUpdate":null,"tags":["admin-linux","linux"],"title":"Nagios Core 4.x"},"html":"<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 300px; box-shadow: 3px 5px 4px rgba(0,0,0,.1);margin:1rem;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/ae56d256fbd17141a2ffe34e37b3c02e/5a46d/Nagios-Logo-300x82.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.230046948356808%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAYAAABFA8wzAAAACXBIWXMAAA7EAAAOxAGVKw4bAAABAklEQVQY012QLcuDYBSG/Sv+DZPJYJOZB2qyGhaGzWHzI4nFLDYxrBgs/g8VTM4yDW6i3i/ngY3x3vDAc74u7nM4ADiOA5fLBXVdI0kSjOOIx+NBJbxeLxY/n09UVcVyFJPmecYwDGiaBvu+sxxHMJIgCOB5HqIooixLaJqGIAjgOA4URYHv+7jdbvA8D4ZhsNg0TViWha7rmCl6HMGWZWGDYRhClmVEUYTT6QTbthHHMSRJYoPUc71eoes6XNdlcFVVv47JJQOu64o0TZFlGYqiYGu0bYtt25DnOc7nM+73OxugXqqR+r7/wr4OPx+61TRNeL/f+BXlCfxfn1P9wgj4B1vWTUPgYbsqAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/ae56d256fbd17141a2ffe34e37b3c02e/bc663/Nagios-Logo-300x82.webp 213w,\n/static/ae56d256fbd17141a2ffe34e37b3c02e/c85cb/Nagios-Logo-300x82.webp 300w\"\n              sizes=\"(max-width: 300px) 100vw, 300px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/ae56d256fbd17141a2ffe34e37b3c02e/3cb16/Nagios-Logo-300x82.png 213w,\n/static/ae56d256fbd17141a2ffe34e37b3c02e/5a46d/Nagios-Logo-300x82.png 300w\"\n            sizes=\"(max-width: 300px) 100vw, 300px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/ae56d256fbd17141a2ffe34e37b3c02e/5a46d/Nagios-Logo-300x82.png\"\n            alt=\"Nagios Logo 300x82\"\n            title=\"Nagios Logo 300x82\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<p>Outil libre de <strong>supervision d'infrastructure</strong>, <a href=\"https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/4/en/monitoring-linux.html\">Nagios</a> est sur le marché depuis 1996 ?... (alors appelé NetSaint ?). Il permet d'effectuer plusieurs type de supervision sur les serveurs ou équipements réseau distants, et les checks basiques peuvent être effectués dès que le serveur installé. Il est ensuite possible d'utiliser des <a href=\"https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/4/en/addons.html#nrpe\">addons</a> pour superviser des équipements spécifiques, des middlwares ou autres.</p>\n<h2>Serveur Nagios Core 4.x</h2>\n<h3>Installation</h3>\n<p>La version 4 de Nagios n'est pas actuellement dispo par APT, et l'installation du serveur (qui comprend le service et l'interface web de Nagios) passe donc par une phase de compilation puis d'installation depuis les sources ?. Mais pas d'inquiétude tout a déjà été scripté pour nous ?. Il suffit de suivre le <a href=\"https://support.nagios.com/kb/article/nagios-core-installing-nagios-core-from-source-96.html#Debian\">guide officiel</a> qui nous guide pas à pas en donnant la séquence de commandes à taper pour installer Nagios4. L'install sur nos distributions  favorites Debian, Raspbian, Ubuntu est documenté (Attention à bien respecter les commandes pour votre version d'OS !)</p>\n<p>Vérifier l'installation de Nagios 4 coté serveur avec un sudo service nagios status</p>\n<p>et vous pouvez désormais accéder à l'interface web de Nagios visible sur <em>http://ip_de_votre_serveur_nagios/nagios</em></p>\n<h3>Configuration</h3>\n<p>Une fois le serveur installé, il nous faut ajouter des <a href=\"https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/3/en/configobject.html\">objets</a> à superviser, et Nagios distingue les Services et les Hôtes tout deux regroupable.</p>\n<p>Les fichier de configurations sur ma distribution Ubuntu sont:</p>\n<p>/usr/local/nagios/etc/nagios.cgf # fichier de configuration principal de Nagios (qui référence les autres fichiers de conf)</p>\n<p>/usr/local/nagios/etc/objects/*.cfg # templates de fichiers de conf</p>\n<p>j'ai décidé de dupliquer le fichier /usr/local/nagios/etc/objects/localhost.cfg  en maconf.cfg j'ai remplacé la ligne contenant localhost.cfg par la suivante dans nagios.cgf :</p>\n<p>cfg_file=/usr/local/nagios/etc/objects/maconf.cfg</p>\n<p>un petit test de la conf sudo service nagios reload -t et si tout va bien on reload le service (sans le -t).</p>\n<h2>NRPE</h2>\n<h3>coté sur Raspberry Pi</h3>\n<p>Pour pouvoir effectuer des <strong>contrôles plus poussés</strong> (CPU, mémoire etc) ou même <strong>custom</strong>, il est utile de passer par un <strong>addon Nagios</strong> nommé NRPE <a href=\"https://exchange.nagios.org/directory/Addons/Monitoring-Agents/NRPE--2D-Nagios-Remote-Plugin-Executor/details\">?</a> qui sera a installer coté machine a surveiller (client):</p>\n<p>sudo apt install nagios-nrpe-server</p>\n<p>Il faudra ensuite <strong>ouvrir le port 5666 coté client</strong>, port utilisé par nrpe serveur (oui oui c'est le serveur qui doit être installé sur la machine a surveiller) si nécessaire.</p>\n<p>Editer le fichier de conf /etc/nagios/nrpe.cfg en modifiant la ligne <strong>allowed_hosts</strong>=<em>adresse_ip_serveur_nagios</em> puis redémarrer le service:</p>\n<p>sudo service nagios-nrpe-server restart</p>\n<p>le fichier de config nrpe.cfg nous fourni déjà plusieurs checks et aussi quelques autres que l'on peut décommenter :</p>\n<p>command[check_users]=/usr/lib/nagios/plugins/check_users -w 5 -c 10\ncommand[check_load]=/usr/lib/nagios/plugins/check_load -w 15,10,5 -c 30,25,20\ncommand[check_hda1]=/usr/lib/nagios/plugins/check_disk -w 20% -c 10% -p /dev/hda1\ncommand[check_zombie_procs]=/usr/lib/nagios/plugins/check_procs -w 5 -c 10 -s Z\ncommand[check_total_procs]=/usr/lib/nagios/plugins/check_procs -w 150 -c 200</p>\n<h3>coté serveur</h3>\n<p>Il faut installer le plugin <strong>nagios-nrpe-plugin</strong> c'est l'outil qui va permettre à Nagios serveur d'interroger les clients:</p>\n<p>sudo apt install nagios-nrpe-plugin</p>\n<p>Une fois le binaire installé /usr/local/nagios/libexec/check_nrpe , il possible d'effectuer un test en live:</p>\n<p>check_nrpe -H adresse_ip_machine_a_surveiller -c check_load</p>\n<p>Pour finir, définir la <em>commande</em> check_nrpe dans /usr/local/nagios/etc/objects/<strong>commands.cfg:</strong></p>\n<p>define command {\ncommand_name check_nrpe\ncommand_line /usr/local/nagios/libexec/check_nrpe -H $HOSTADDRESS$ -c $ARG1$\n}</p>\n<p>pour la rendre disponible dans les fichiers de config /usr/local/nagios/etc/objects/maconf.cfg:</p>\n<p>define service {\nuse generic-service\nhost_name ip_de_lobjet_reseau_a_surveiller\nservice_description CPU Load\ncheck_command check_nrpe!check_load\nnotifications_enabled 0\n}</p>\n<h3>Troubleshooting et test de communication client/serveur</h3>\n<ul>\n<li>vérifier si le <strong>port 5666 est bien ouvert coté client</strong> avec un bon vieux <a href=\"https://www.digitalocean.com/community/tutorials/how-to-use-netcat-to-establish-and-test-tcp-and-udp-connections-on-a-vps\">netcat</a> par exemple:\nnetcat -z -v -n 192.168.1.32 5666</li>\n<li>vérifier que le <strong>service</strong> tourne bien coté client:\nsudo service nagios-nrpe-server status</li>\n<li>fichiers de log coté serveur:\ntail /usr/local/nagios/var/nagios.log</li>\n<li>vous trouverez la doc officiel de <a href=\"https://assets.nagios.com/downloads/nagioscore/docs/nagioscore/4/en/toc.html\">Nagios Core 4.x</a> et du plugin NRPE en <a href=\"https://github.com/NagiosEnterprises/nrpe/blob/56492da4e4b55c8d188ed8114a88c18f0250ff55/docs/NRPE.pdf\">pdf</a></li>\n</ul>\n<h2>Screenshot</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 850px; box-shadow: 3px 5px 4px rgba(0,0,0,.1);margin:1rem;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/35396f816ee622db590acb07ceafe3b4/0c3d0/Nagios4.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.21596244131455%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAA7DAAAOwwHHb6hkAAACQUlEQVQoz52SO2/UQBSF/bvy01JEUKWhokAgQQESFUkBVAgKJIqkCKGIkrW99mYffr/Gj/WM17ubD80E0pCKka48V3fu8bnnHqtpGnSUZYlUCqUUUvas12v6vkcpiZLS5PJvrqSpdV1netM0pchyhBBY5+fneJ5HnmcsFguCYEWeF0gpqduGVRARhAl9LymqiiCICcOYqmrYbrcmhmGgbVvztfzZLV3XEoUhk4mNO/URomG33xFmAVfXNo7j0aueuNRvfK5vHLKs4LFj3c4DpFTUdUPTSkS9RqnNwwPNLM9zRCVom5aiKOi6tand3d39E9bU14ADZVlQVSVCVOx2OzbjhrZr6drW6KT1ua8Lk2utH2WYpKVB1kupKoE/m9MUHd+vP/P+53OciYM3nTJ1HMIgIE0T7MkE13HxPY84ismyjDiKkL3EWq4Sw6jv78dYBjFd0fPp8h2vLp7iuZ4B9FzXNGVpius4TF2Xyc2NuUdhRJ5lZpHWfJnSrZVZzDhumS9DmnzNt6sT3l4+w3c9w2TqOgZQN2oQx7YfgLWutRDGXlbbdUg1UNc1gxq4nS8owpKPZ6958+sYz/Hwfc80G4ZZivMHyLZtgtWKIs9NbPd7rDQrjMDaqFrLZRBRxYIPP17w8uKJGVkD6pG1tdIkeWB2O5uxmM9ZLZdEUcTp0RFWEJWM484YdBxH9A9E3nA2+cLX2QlJlJAksWFXVRVNUxtgE1FomOnN65GPDw40YMV2uzcu32w2DMPG3P/nnB4e8hu/iH41w39x8QAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/35396f816ee622db590acb07ceafe3b4/bc663/Nagios4.webp 213w,\n/static/35396f816ee622db590acb07ceafe3b4/8dc4f/Nagios4.webp 425w,\n/static/35396f816ee622db590acb07ceafe3b4/10237/Nagios4.webp 850w,\n/static/35396f816ee622db590acb07ceafe3b4/5e05a/Nagios4.webp 1275w,\n/static/35396f816ee622db590acb07ceafe3b4/1a117/Nagios4.webp 1414w\"\n              sizes=\"(max-width: 850px) 100vw, 850px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/35396f816ee622db590acb07ceafe3b4/3cb16/Nagios4.png 213w,\n/static/35396f816ee622db590acb07ceafe3b4/2fbbf/Nagios4.png 425w,\n/static/35396f816ee622db590acb07ceafe3b4/ae694/Nagios4.png 850w,\n/static/35396f816ee622db590acb07ceafe3b4/3f20e/Nagios4.png 1275w,\n/static/35396f816ee622db590acb07ceafe3b4/0c3d0/Nagios4.png 1414w\"\n            sizes=\"(max-width: 850px) 100vw, 850px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/35396f816ee622db590acb07ceafe3b4/ae694/Nagios4.png\"\n            alt=\"Nagios4\"\n            title=\"Nagios4\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>"}},"staticQueryHashes":["1026020893","28434099","3153813225"]}