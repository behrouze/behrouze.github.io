{
    "componentChunkName": "component---src-templates-wp-post-tsx",
    "path": "/certificats-ssl-tls-gratuits-letsencrypt",
    "result": {"pageContext":{"id":"af9d0ef3-48a9-5cb8-a38c-0bc456512eef","fileAbsolutePath":"/home/behrouze/Sources/blog/obsidian/Blog/certificats-ssl-tls-gratuits-letsencrypt.md","frontmatter":{"categories":["linux"],"date":"2018-08-30","lastUpdate":"2022-03-08","tags":["admin-linux","linux","certbot","ssl"],"title":"Let's Encrypt: les certificats SSL/TLS gratuits"},"html":"<p><a href=\"https://letsencrypt.org/\">Let’s Encrypt</a> est une <strong>autorité de certification</strong> 🔐(CA en anglais) qui délivre la <a href=\"https://censys.io/certificates/report?q=tags%3Atrusted&#x26;field=parsed.issuer.organization.raw&#x26;max_buckets=50\">plupart des certificats TLS / SSL</a> dans le monde (<em>plus de 56%</em> des certificats, le 2ème CA étant <em>Cloudflare avec 13%</em> – chiffres d’Aout 2020) et est gérée par l’<a href=\"https://letsencrypt.org/isrg/\">ISRG</a> qui est <a href=\"https://letsencrypt.org/sponsors\">sponsorisé</a> par quelques mastodontes du web tel que Mozilla, Akamai, Cisco, <a href=\"https://www.eff.org/\">EFF</a>.</p>\n<h1>Certbot</h1>\n<p><strong>Let’s Encrypt</strong> présente la particularité de fournir <strong>gratuitement 🎉</strong> un <strong>système automatisé de délivrance de certificats SSL</strong> (ou TLS), et pour cela l’ISRG a développé le <a href=\"https://fr.wikipedia.org/wiki/ACME_(protocole)\">protocole ACME</a>  que l’on peut exploiter grâce au CLI <a href=\"https://certbot.eff.org/about/\">Certbot</a> (développé par l’EFF).</p>\n<p><a href=\"https://certbot.eff.org\">Certbot</a> (anciennement 💀 certbot-auto ou letsencrypt) est l’outil qui va nous permettre de :</p>\n<ul>\n<li><strong>gérer</strong> (<em>obtenir</em>, <em>renouveler</em> ou <em>révoquer</em>) les certificats SSL Let’s Encrypt</li>\n<li><strong>installer</strong> ces certificats sur notre <strong>serveur Web</strong></li>\n</ul>\n<p><em>Certbot n’est actuellement disponible que sur les Unix/Linux</em>.</p>\n<h1>Installation</h1>\n<h2>Déterminer notre OS</h2>\n<p>Pour l’installer suivre la <a href=\"https://certbot.eff.org/instructions\">procédure propre à chaque système</a>, identifier notre système et versions par :</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">grep</span> -wE <span class=\"token string\">'ID_LIKE|VERSION'</span> /etc/*-release</code></pre></div>\n<h2>Installer le CLI Certbot</h2>\n<p>S'assurer de ne pas avoir un ancien binaire qui traine sinon faire un <code class=\"language-text\">sudo apt-get remove certbot</code>, puis il suffit d'utiliser <a href=\"https://snapcraft.io/certbot\">snapd</a> pour installer la CLI Certbot:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> <span class=\"token function\">apt</span> <span class=\"token function\">install</span> snapd\n<span class=\"token function\">sudo</span> snap <span class=\"token function\">install</span> core\n<span class=\"token function\">sudo</span> snap refresh core\n<span class=\"token function\">sudo</span> snap <span class=\"token function\">install</span> --classic certbot\n<span class=\"token function\">sudo</span> <span class=\"token function\">ln</span> -s /snap/bin/certbot /usr/bin/certbot\n<span class=\"token function\">sudo</span> snap <span class=\"token builtin class-name\">set</span> certbot trust-plugin-with-root<span class=\"token operator\">=</span>ok\n<span class=\"token function\">sudo</span> certbot --version</code></pre></div>\n<h1>Principe d’utilisation de Certbot</h1>\n<p><code class=\"language-text\">certbot</code> permet via la ligne de commande, d’effectuer les actions suivantes grâce à un <a href=\"https://certbot.eff.org/docs/using.html#getting-certificates-and-choosing-plugins\">système de plugins</a> qu’il est important de bien comprendre. Ces Plugins sont de 2 types:</p>\n<ol>\n<li>les plugins <strong>authenticators</strong></li>\n<li>les plugins <strong>installers</strong></li>\n</ol>\n<h2>Mode interactif</h2>\n<p>Le plus simple consiste a exécuter la commande <code class=\"language-text\">certbot</code> en mode interactif (avec des questions réponses), par exemple la commande suivante va nous aider à générer des certificats pour les domaines hébergés sur le nginx :</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> certbot --nginx</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 685px; box-shadow: 3px 5px 4px rgba(0,0,0,.1);margin:1rem;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/30a9f3cc73ce6861d3735b00b5205ab8/8ce22/certbot-mode-interactif.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 30.98591549295775%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAIAAABM9SnKAAAACXBIWXMAAA7DAAAOwwHHb6hkAAAA10lEQVQY043L226EIBgEYN//ebrZmGZ1oz1kPSwqwo8CIqiA9CWauDdt0yadfJnMzURFz9M7XGp4RXB7r7OsTK+3LC/yvGioKIlATNZUSL3s3lv3LREVcz8qkDMRmo1T2xKMgRLWYcAdINQTDAwGa38cj/MwaZAzk/Mw6UkbORtxGJXmx1Bmcc5t27Y+WPtgnY2EWgssi142oEa5bKv3dg8+BB8+jg4+7G7/VYQ4i+/VqSpjVF86VAnSKMo3Pn7B/xC9DG8nen5qzzF/vujkatLUpIlJ/uMTTMEyAt0pVy8AAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/30a9f3cc73ce6861d3735b00b5205ab8/bc663/certbot-mode-interactif.webp 213w,\n/static/30a9f3cc73ce6861d3735b00b5205ab8/8dc4f/certbot-mode-interactif.webp 425w,\n/static/30a9f3cc73ce6861d3735b00b5205ab8/80e32/certbot-mode-interactif.webp 685w\"\n              sizes=\"(max-width: 685px) 100vw, 685px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/30a9f3cc73ce6861d3735b00b5205ab8/3cb16/certbot-mode-interactif.png 213w,\n/static/30a9f3cc73ce6861d3735b00b5205ab8/2fbbf/certbot-mode-interactif.png 425w,\n/static/30a9f3cc73ce6861d3735b00b5205ab8/8ce22/certbot-mode-interactif.png 685w\"\n            sizes=\"(max-width: 685px) 100vw, 685px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/30a9f3cc73ce6861d3735b00b5205ab8/8ce22/certbot-mode-interactif.png\"\n            alt=\"certbot en mode interactif\"\n            title=\"certbot en mode interactif\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h2>Authentifier votre serveur web</h2>\n<p><strong>Certbot</strong> va nous permettre d’<strong>authentifier le serveur web</strong> qui <strong>héberge le domaine</strong> pour lequel nous souhaitons obtenir le certificat SSL (valide pour une durée de 3 mois).</p>\n<p>Pour cette étape, il faut utiliser les <strong>plugins de type authenticators</strong> que l’on va spécifier via la <em>sous-commande</em> <strong><code class=\"language-text\">certonly</code></strong>, voici un exemple d’utilisation du plugin authenticator <a href=\"https://eff-certbot.readthedocs.io/en/stable/using.html#webroot\">webroot</a> avec l’option <code class=\"language-text\">--webroot-path</code> (<code class=\"language-text\">-w</code>) et l’option <code class=\"language-text\">--dry-run</code> qui permet <a href=\"https://letsencrypt.org/docs/rate-limits/\">tester sa config</a> :</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> certbot certonly --webroot -w /var/www/example -d www.example.com -d example.com --dry-run </code></pre></div>\n<h2>Installer le certificat</h2>\n<p>La CLI peut <em>éventuellement</em> permettre d’installer ce certificat sur votre serveur web (Nginx, Apache etc.), pour cela il faut utiliser les <strong>plugins de type installers</strong> via la <em>sous-commande</em> <strong><code class=\"language-text\">install</code></strong></p>\n<p><em>Certains plugins</em> sont des <strong>authenticators</strong> et des <strong>installers</strong> comme les <a href=\"https://eff-certbot.readthedocs.io/en/stable/using.html#getting-certificates-and-choosing-plugins\">plugins apache et ngnix</a> (voir également les <a href=\"https://eff-certbot.readthedocs.io/en/stable/using.html#third-party-plugins\">plugins non officiels</a>), ils sont alors utilisable via la sous-commande <strong><code class=\"language-text\">run</code></strong> (qui est implicitement utilisée lorsqu’on ne spécifie ni <code class=\"language-text\">certonly</code>, ni <code class=\"language-text\">install</code>).<br>\nIl faudra alors utiliser des options pour spécifier le type de plugin :</p>\n<ul>\n<li><code class=\"language-text\">--authenticator</code>  (ou <code class=\"language-text\">-a</code>)</li>\n<li><code class=\"language-text\">--installer</code> (ou <code class=\"language-text\">-i</code>)</li>\n</ul>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> certbot run -a webroot -i nginx -w /var/www/html -d example.com</code></pre></div>\n<p>Si on souhaite <strong>obtenir un certificat manuellement</strong>, il est possible  d’utiliser le <a href=\"https://eff-certbot.readthedocs.io/en/stable/using.html#manual\">plugin authenticator manual</a>.</p>\n<h2>Certificats wildcard</h2>\n<p>Si vous possédez de nombreux sous domaines ou que pour des raisons de sécurité vous souhaitez éviter leurs énumérations par certificats, <a href=\"https://letsencrypt.org/2017/07/06/wildcard-certificates-coming-jan-2018.html\">Let’s Encrypt nous offre depuis Janv 2018</a> des certificats joker (wildcard certificate), et pour cela il suffit de spécifier en <code class=\"language-text\">-d *.votrenomdedomaine.fr</code>.<br>\nPour compléter la procédure, vous devrez avoir accès à votre registrar pour ajouter un champs DNS de type TXT.<br>\nVoici la commande pour générer le certificat manuellement sans plugins:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> certbot --server https://acme-v02.api.letsencrypt.org/directory -d *.behrouze.com --manual --preferred-challenges dns-01 certonly</code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 850px; box-shadow: 3px 5px 4px rgba(0,0,0,.1);margin:1rem;\"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/497d0b290b8394ffab4a4a66df9532e8/9cea8/certbot-certificat-wildcard.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 58.68544600938967%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAA7DAAAOwwHHb6hkAAABOUlEQVQoz42RWW7CMBBAc/9jURBlT0K871tmwikqJ1C1EtCOnqz58PMsblaHYXum6133sdrtt6fPzXG/PfGBKcrFwCRhhglJuKZcEa4olwMTV6ZopTkRdSbqwnQvXEgFEQBguk04zbEkt1/JNw3VgZlAtR+Uo9r30hLlqfJEeWkjjPWt+wmP/EEzKFdva3+VVTYhxVxyKamUXH5KT6IRLlahjCGXWRvLOI4IFQBAhGWSp3J75ceOXnrW0To5lTb6gDHCDMYEOb+UKZVkRkojpDXGj96DdxAChIAhvJOP1LTCddLhhLh0iIgT3ht+3/aFmwPRpK7XMe2JdnUFqQ4Of0XTcrvt5aYT61YciD4zQ7RnJoSUX5d8yJ2wi9MJu9AK0wvnY8Y/Kw/K9cKakELKNmYyf/igvPuH/AUWYHlMywtIVAAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <picture>\n          <source\n              srcset=\"/static/497d0b290b8394ffab4a4a66df9532e8/bc663/certbot-certificat-wildcard.webp 213w,\n/static/497d0b290b8394ffab4a4a66df9532e8/8dc4f/certbot-certificat-wildcard.webp 425w,\n/static/497d0b290b8394ffab4a4a66df9532e8/10237/certbot-certificat-wildcard.webp 850w,\n/static/497d0b290b8394ffab4a4a66df9532e8/5e05a/certbot-certificat-wildcard.webp 1275w,\n/static/497d0b290b8394ffab4a4a66df9532e8/893d6/certbot-certificat-wildcard.webp 1278w\"\n              sizes=\"(max-width: 850px) 100vw, 850px\"\n              type=\"image/webp\"\n            />\n          <source\n            srcset=\"/static/497d0b290b8394ffab4a4a66df9532e8/3cb16/certbot-certificat-wildcard.png 213w,\n/static/497d0b290b8394ffab4a4a66df9532e8/2fbbf/certbot-certificat-wildcard.png 425w,\n/static/497d0b290b8394ffab4a4a66df9532e8/ae694/certbot-certificat-wildcard.png 850w,\n/static/497d0b290b8394ffab4a4a66df9532e8/3f20e/certbot-certificat-wildcard.png 1275w,\n/static/497d0b290b8394ffab4a4a66df9532e8/9cea8/certbot-certificat-wildcard.png 1278w\"\n            sizes=\"(max-width: 850px) 100vw, 850px\"\n            type=\"image/png\"\n          />\n          <img\n            class=\"gatsby-resp-image-image\"\n            src=\"/static/497d0b290b8394ffab4a4a66df9532e8/ae694/certbot-certificat-wildcard.png\"\n            alt=\"certbot pour obtention de certificat wildcard\"\n            title=\"certbot pour obtention de certificat wildcard\"\n            loading=\"lazy\"\n            decoding=\"async\"\n            style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n          />\n        </picture>\n  </a>\n    </span></p>\n<h1>Gestion des certificats</h1>\n<h3>Lister les certificats</h3>\n<p>Certbot propose de nombreuses possibilité en matière de <a href=\"https://certbot.eff.org/docs/using.html#managing-certificates\">gestion de certificats</a>.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> certbot certificates</code></pre></div>\n<p>permet d’<strong>afficher</strong> les informations concernant les <strong>certificats SSL actuellement installés</strong> sur votre serveur, leurs <strong>localisation</strong> dans le système de fichier ainsi que leurs <strong>date d’expiration</strong>.</p>\n<p>⚠ <em>Attention</em>: A noter que cette sous-commande nous indique les informations concernant nos <strong>domaines</strong> ainsi que les fichiers de <strong>clés privés</strong> et <strong>certificats</strong>, par contre <strong>elle n’indique pas</strong> si notre <strong>serveur web est correctement configuré</strong> pour les exploiter.</p>\n<h3>Révoquer un certificat</h3>\n<p>En cas d’attaque du serveur web contenant les certificats, il est important de <a href=\"https://certbot.eff.org/docs/using.html#revoking-certificates\">révoquer</a> et supprimer les certificats installés (car exploitable par les hackers), puis en régénérer de nouveaux:</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> certbot revoke --cert-path /etc/letsencrypt/live/CERTNAME/cert.pem --reason keycompromise</code></pre></div>\n<p>l’option <code class=\"language-text\">--reason</code> est optionnelle et peut comprendre les valeurs :<br>\nunspecified (par défaut) keycompromise affiliationchanged superseded ou cessationofoperation</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token function\">sudo</span> certbot delete --cert-name example.com</code></pre></div>\n<h3>Gestion des certificats</h3>\n<p>Le <strong>renouvellement</strong> de certificat s’effectue via la commande <code class=\"language-text\">certbot renew</code> et il sera utile de mettre un job <code class=\"language-text\">cron</code> pour automatiser cette tache et ne pas se retrouver avec des certificats expirés…</p>\n<p>Les <a href=\"https://certbot.eff.org/docs/using.html#modifying-the-renewal-configuration-file\">fichiers de configuration de certbot</a> sont situés dans le dossier suivant <code class=\"language-text\">/etc/letsencrypt/renewal/nom_certificat</code>. Pour <strong>annuler</strong> le renouvellement de certains certificat, il suffit de <strong>supprimer le fichier</strong> correspondant au certificat dans ce dossier.</p>\n<h1>Aller plus loin</h1>\n<p>Pour bien comprendre le fonctionnement de Certbot cad le <em>process d’obtention et d’installation de certificats</em> et son système de plugins lire le <a href=\"https://certbot.eff.org/docs/using.html\">User Guide</a>, un peu long 😒 mais très intéressant 👍</p>\n<p>Le site de <a href=\"https://letsencrypt.org/docs/\">Let’s Encrypt</a> comporte également beaucoup d’informations.</p>"}},
    "staticQueryHashes": ["1026020893","28434099","3153813225"]}